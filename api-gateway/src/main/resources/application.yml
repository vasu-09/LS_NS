server:
  port: ${SERVER_PORT:8080}

spring:
  application:
    name: ${SPRING_APPLICATION_NAME:api-gateway}
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}
  config:
    import: "optional:configserver:"

  cloud:
    kubernetes:
      discovery:
        enabled: ${SPRING_CLOUD_KUBERNETES_DISCOVERY_ENABLED:true}
    gateway:
      routes:
        - id: auth-service
          uri: lb://authentication-service         # service ID is stable; keep literal
          predicates:
            - Path=/auth/**,/user/**,/contacts/**,/.well-known/jwks.json,/v1/keys/**,/webhooks/sms-dlr,
#          filters:
#            - StripPrefix=1

        - id: notification-service
          uri: lb://notification-service
          predicates:
            - Path=/notifications/**


        - id: rtc-service
          uri: ${RTC_WS_URI:lb:ws://real-time-communication}  # websocket route; env overrideable
          predicates:
            - Path=/rtc/**,/ws/**,/api/search/**,/api/blocks/**,/api/calls/**,/api/dm/**,/api/e2ee/**,/api/media/**,/api/message/**,/api/messages/**,/api/readmodel/**,/api/rooms/**


        - id: todo-service
          uri: lb://to-do-list-service
          predicates:
            - Path=/api/v1/payments/**,/api/lists/**


      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_FIRST

      httpclient:
        connect-timeout: ${GATEWAY_CONNECT_TIMEOUT_MS:5000}
        response-timeout: ${GATEWAY_RESPONSE_TIMEOUT:10s}

      globalcors:
        corsConfigurations:
          "[/**]":
            allowedOrigins: ${CORS_ALLOWED_ORIGINS:http://localhost:3000}
            allowedMethods: ${CORS_ALLOWED_METHODS:GET,POST,PUT,PATCH,DELETE,OPTIONS}
            allowedHeaders: ${CORS_ALLOWED_HEADERS:*}
            exposedHeaders: ${CORS_EXPOSED_HEADERS:Authorization,Content-Type}
            allowCredentials: ${CORS_ALLOW_CREDENTIALS:true}
            maxAge: ${CORS_MAX_AGE:3600}

  security:
    oauth2:
      resourceserver:
        jwt:
#          jwk-set-uri: ${JWT_JWKS_URI:http://localhost:8092/.well-known/jwks.json}
          issuer-uri: ${JWT_ISSUER:http://localhost:8092}
#          jwk-set-uri: http://localhost:8092/.well-known/jwks.json
jwt:
  audience: ${JWT_AUDIENCE:}

management:
  endpoints:
    web:
      exposure:
        include: ${MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE:health,info,prometheus}

rate:
  limit:
    requests: 60
    window-seconds: 60

gateway:
  custom-jwt:
    enabled: false

